{% extends "admin/change_form.html" %}

{% block extrahead %}
	<script type="text/javascript" src="/static/scripts/dojo/dojo.js"></script>
	<script type="text/javascript">
dojo.require("dojo.io.script");

var isValidISBN = function(/* String */value) {
    // summary: Vadlidate ISBN-10 or ISBN-13 based on the length of value
	// returns: Boolean
	// not in the trunk right now.

    var len, sum, weight;
    if(typeof value!='string'){
        value = String(value);
    }
	value = value.replace(/[- ]/g,''); //ignore dashes and whitespaces
    len = value.length;
    sum = 0;
    if(len == 10) {
        weight = 10;
        // ISBN-10 validation algorithm
        for(var i = 0; i< 9; i++) {
            sum += parseInt(value.charAt(i)) * weight;
            weight --;
        }
        var t = value.charAt(9).toUpperCase();
        sum += t == 'X' ? 10 : parseInt(t);
        return sum % 11 == 0;
    } else if(len == 13) {
        weight = -1;
        for(var i=0; i< len; i++) {
            sum += parseInt(value.charAt(i)) * (2 + weight);
            weight *= -1;
        }
        return sum % 10 == 0;
    } else {
        return false;
    }
};

var removeRows = function() {
	var rows = dojo.byId("books");
	var firstrow = dojo.byId("firstrow");
	// remove the last search result:
	for(var c = firstrow.nextSibling; c != null;) {
		var t = c.nextSibling;
		rows.removeChild(c);
		c = t;
	}
};

dojo.addOnLoad(function() {
	var cache = null;
	
	// hook the search
	dojo.connect(dojo.byId("btn_search"), 'onclick', function() {
		var value = dojo.byId("search").value;
		if(isValidISBN(value)) {
			// strip off the dash and space
			value = value.replace(/[- ]/g,''); //ignore dashes and whitespaces
		}
		removeRows();
		
		dojo.io.script.get({
			url: 'http://ecs.amazonaws.com/onca/xml',
			content: {
				Service: 'AWSECommerceService',
				SubscriptionId: '19267494ZR5A8E2CGPR2',
				AssociateTag: 'kokogiak7-20',
				Operation: 'ItemSearch',
				SearchIndex: 'Books',
				ResponseGroup: 'Medium,ItemAttributes,OfferFull',
				Keywords: escape(value),
				Style: 'http://www.kunxi.org/files/learning-django-by-example/awsitems.xsl',
				ContentType: 'text/javascript',
			},
			callbackParamName: "CallBack",
			}).addCallback(function(items) {
				var id = 0;
				var rows = dojo.byId("books");
				var firstrow = dojo.byId("firstrow");
				// hide the firstrow if we find something:
				if (items.length) {
					cache = items; // cache it for later use
					firstrow.style.display = "none";
					dojo.forEach(items, function(item) {
						var node = document.createElement("div");
						node.innerHTML = '<div class="form-row"> <dl> <dt><img src="' + item.thumburl 
							+ '" align="left"/> <dd><p>' + item.title 
							+ '</p> <p>by ' + item.authors.join(', ') + '</p><p>Publisher: ' + item.publisher
							+ '</p> <p>Pub Date: ' + item.pub_date + '</p> </dd> </dl> <br/>'
							+ '<input class="incoming" type="text" id="' + id  + '"/> </div>';
						rows.appendChild(node);
					});
				} else {
					cache = null;
					firstrow.style.display = "";
				}
			});
	});


	// hijack the submit
	dojo.connect(dojo.query("#book_form input[@type=submit]")[0], 'onclick', function(e) {
		dojo.stopEvent(e);
		if (cache) {
			// cache is fectched in last search
			var i = 0;
			var formdata = [];
			dojo.forEach(dojo.query("#book_form input[@class=incoming]"), function(item) {
				if (item.value != "") {
					formdata.push(cache[i]);
				}	
				i++;
			});
			dojo.xhrPost({
				url: dojo.byId("book_form").action,
				content: { items: dojo.toJson(formdata) },
			}).addCallback(function(response) {
				var result = dojo.fromJson(response);
				var messages = dojo.query("ul[@class=messagelist]")[0]
				dojo.forEach(result.failed, function(item) {
					var msg = document.createElement("li");
					msg.innerHTML = "<li><em>" + item + "</em> <strong>failed</strong> to add.</li>"
					messages.appendChild(msg);
				});
				dojo.forEach(result.succeed, function(item) {
					var msg = document.createElement("li");
					msg.innerHTML = "<em>" + item + "</em> successfully added."
					messages.appendChild(msg);
				});
				
			});
		}
		});
});
	</script>
{% endblock %}
{% block content %}
		<div id="content-main">
		<ul class="messagelist"></ul>
		<h1>Add Book</h1>
			<input type="text" id="search" class="vTextField" name="search" size="30" value=""/>
			<input type="button" id="btn_search" value="Search" />
			<form action="{{ request.path }}" method="post" id="book_form"> <div>
				<fieldset class="module aligned ()" id="books">
				<div class="form-row" id="firstrow"> No book found
				</div>
				</fieldset>
					<div class="submit-row">
						<!-- <input type="submit" value="Save and add another" name="_addanother"  />
						<input type="submit" value="Save and continue editing" name="_continue" /> -->
						<input type="submit" value="Save" class="default" />
					</div>

			</div></form>
		</div>
{% endblock %}
