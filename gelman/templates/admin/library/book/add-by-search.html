{% extends "admin/change_form.html" %}

{% block extrahead %}
	<link rel="stylesheet" href="http://localhost:8000/static/css/admin.css" type="text/css" media="screen" />
	<script type="text/javascript" src="/static/scripts/dojo/dojo.js"></script>
	<script type="text/javascript">
dojo.require("dojo.io.script");
dojo.require("dojo.io.iframe");
dojo.require("dojox.validate.isbn");

var cache = null;

function popup(isbn, index) {
	dojo.query("#"+isbn+" div" ).forEach(function(item, i) {
		if(i == index) {
			item.setAttribute("class", "enabled");
		} else {
			item.setAttribute("class", "disabled");
		}
	});
}

function save(isbn) {
	var form = dojo.query("#"+ isbn + " form")[0];
	for (var i=0, l=cache.length; i< l; i++) {
		if (cache[i].isbn == form.name) {
			break;
		}
	}
	var meta = dojo.query("input[@name=meta]", form)[0];
	meta.value = dojo.toJson(cache[i]);

	// submit the form
	dojo.io.iframe.send({
		url: form.action,
		method: "post",
		handleAs: "text",
		form: form,
		handle: function(data, ioArgs) {
			var msgs = document.createElement("ul");
			console.debug(data);
			if (data == "succeed") {
				msgs.innerHTML = '<ul class="messagelist enabled">'
					+ '<li>Succeed to add ' + cache[i].title + '.';
			} else {
				msgs.innerHTML = '<ul class="errorlist enabled">'
					+ '<li>Failed to add ' + cache[i].title + '.';
			}
			form.appendChild(msgs);
		}
	});
};


dojo.addOnLoad(function() {
	// hook the search
	dojo.connect(dojo.byId("btn_search"), 'onclick', function() {
		var value = dojo.byId("search").value;
		if(dojox.validate.isValidIsbn(value)) {
			// strip off the dash and space
			value = value.replace(/[- ]/g,''); //ignore dashes and whitespaces
		}
		// remove the last search
		var rows = dojo.byId("books");
		var firstrow = dojo.byId("firstrow");
		// remove the last search result:
		for(var c = firstrow.nextSibling; c != null;) {
			var t = c.nextSibling;
			rows.removeChild(c);
			c = t;
		}
		
		dojo.io.script.get({
			url: 'http://ecs.amazonaws.com/onca/xml',
			content: {
				Service: 'AWSECommerceService',
				SubscriptionId: '19267494ZR5A8E2CGPR2',
				AssociateTag: 'kokogiak7-20',
				Operation: 'ItemSearch',
				SearchIndex: 'Books',
				ResponseGroup: 'Medium,ItemAttributes,OfferFull',
				Keywords: escape(value),
				Style: 'http://www.kunxi.org/files/learning-django-by-example/awsitems.xsl',
				ContentType: 'text/javascript',
			},
			callbackParamName: "CallBack",
			}).addCallback(function(items) {
				var rows = dojo.byId("books");
				var firstrow = dojo.byId("firstrow");
				// hide the firstrow if we find something:
				if (items.length) {
					cache = items; // cache it for later use
					firstrow.style.display = "none";
					dojo.forEach(items, function(item) {
						var node = document.createElement("div");
						node.setAttribute("class", "adminbrief");
						node.innerHTML = '<dl><dt><img src="' + item.thumburl 
						+ '"/></dt><dd><h3>' + item.title 
						+ '</h3> <p>by ' + item.authors.join(', ') 
						+ '</p><p>ISBN-10:' + item.isbn
						+ '</p><p>Publisher: ' + item.publisher + '</p>'
						+ '</dd> </dl>'
						+ '<div id="' + item.isbn +'" class="actionbox">'
						+ '<a onclick="popup(\'' + item.isbn +'\', 0)">Attach a file</a> | '
						+ '<a onclick="save(\'' + item.isbn +'\')">Save</a>'
						+ '<form name="' + item.isbn + '" enctype="multipart/form-data" action="{{request.path}}" method="post">' 
						+ '<div class="disabled">Add: <input type="file" name="handle"/></div>'
						+ '<div class="disabled"><input type="hidden" name="meta" value=""/></div>'
						+ '</form></div>';
						rows.appendChild(node);
					});
				} else {
					cache = null;
					firstrow.style.display = "";
				}
			});
	});
});
	</script>
{% endblock %}
{% block content %}
		<div id="content-main">
		<ul class="messagelist"></ul>
		<h1>Add Book</h1>
			<input type="text" id="search" class="vTextField" name="search" size="30" value=""/>
			<input type="button" id="btn_search" value="Search" />
			<div id="books">
				<div class="form-row" id="firstrow"> No book found. </div>
			</div>
		</div>
{% endblock %}
