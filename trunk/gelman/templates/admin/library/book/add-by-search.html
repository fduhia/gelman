{% extends "admin/change_form.html" %}

{% block extrahead %}
	<link rel="stylesheet" href="http://localhost:8000/static/css/admin.css" type="text/css" media="screen" />
	<script type="text/javascript" src="/static/scripts/dojo/dojo.js"></script>
	<script type="text/javascript">
dojo.require("dojo.io.script");
dojo.require("dojo.io.iframe");
dojo.require("dojox.validate.isbn");


dojo.addOnLoad(function() {
	var cache = null;
	// hook the search
	dojo.connect(dojo.byId("btn_search"), 'onclick', function() {
		var value = dojo.byId("search").value;
		if(dojox.validate.isValidIsbn(value)) {
			// strip off the dash and space
			value = value.replace(/[- ]/g,''); //ignore dashes and whitespaces
		}
		// remove the last search
		var rows = dojo.byId("books");
		var firstrow = dojo.byId("firstrow");
		// remove the last search result:
		for(var c = firstrow.nextSibling; c != null;) {
			var t = c.nextSibling;
			rows.removeChild(c);
			c = t;
		}
		
		dojo.io.script.get({
			url: 'http://ecs.amazonaws.com/onca/xml',
			content: {
				Service: 'AWSECommerceService',
				SubscriptionId: '19267494ZR5A8E2CGPR2',
				AssociateTag: 'kokogiak7-20',
				Operation: 'ItemSearch',
				SearchIndex: 'Books',
				ResponseGroup: 'Medium,ItemAttributes,OfferFull',
				Keywords: escape(value),
				Style: 'http://www.kunxi.org/files/learning-django-by-example/awsitems.xsl',
				ContentType: 'text/javascript',
			},
			callbackParamName: "CallBack",
			}).addCallback(function(items) {
				var rows = dojo.byId("books");
				var firstrow = dojo.byId("firstrow");
				// hide the firstrow if we find something:
				if (items.length) {
					cache = items; // cache it for later use
					firstrow.style.display = "none";
					dojo.forEach(items, function(item) {
						var node = document.createElement("div");
						node.setAttribute("class", "adminbrief");
						node.innerHTML = '<dl><dt><img src="' + item.thumburl 
						+ '"/></dt><dd><h3>' + item.title 
						+ '</h3> <p>by ' + item.authors.join(', ') 
						+ '</p><p>ISBN-10:' + item.isbn
						+ '</p><p>Publisher: ' + item.publisher + '</p>'
						+ '</dd> </dl>'
						+ '<form name="' + item.isbn + '" enctype="multipart/form-data" name="book_update" action="{{request.path}}" method="post">' 
						+ 'Attach a file: <input type="file" name="handle"/>'
						+ '<input type="hidden" name="meta" value=""/>'
						+ '<input type="submit" value="save"/>'
						+ '</form>';
						rows.appendChild(node);
						dojo.connect(dojo.query("input[@type=submit]", node)[0], 'onclick', function(evt) {
							dojo.stopEvent(evt);
							var form = evt.target.parentNode;
							for (var i=0, l=cache.length; i< l; i++) {
								if (cache[i].isbn == form.name) {
									break;
								}
							}
							var meta = dojo.query("input[@name=meta]", form)[0];
							meta.value = dojo.toJson(cache[i]);

							// submit the form
							dojo.io.iframe.send({
								url: form.action,
								method: "post",
								handleAs: "text",
								form: form,
								handle: function(data, ioArgs) {
									console.debug(data);
								}
							});
						});

					});
				} else {
					cache = null;
					firstrow.style.display = "";
				}
			});
	});
});

/*


		if (cache) {
			// cache is fectched in last search
			var i = 0;
			var formdata = [];
			dojo.forEach(dojo.query("#book_form input[@type=file]"), function(item) {
				if (item.value != "") {
					formdata.push(cache[i]);
				}	
				i++;
			});
			dojo.xhrPost({
				url: dojo.byId("book_form").action,
				content: { items: dojo.toJson(formdata) },
			}).addCallback(function(response) {
				var result = dojo.fromJson(response);
				var messages = dojo.query("ul[@class=messagelist]")[0]
				dojo.forEach(result.failed, function(item) {
					var msg = document.createElement("li");
					msg.innerHTML = "<em>" + item + "</em> <strong>failed</strong> to add."
					messages.appendChild(msg);
				});
				dojo.forEach(result.succeed, function(item) {
					var msg = document.createElement("li");
					msg.innerHTML = "<em>" + item + "</em> successfully added."
					messages.appendChild(msg);
				});
				
			});
			dojo.io.iframe.send({
				url: dojo.byId("book_form").action,
				method: "post",
				handleAs: "json",
				form: dojo.byId("book_form"),
			}).addCallback(function(response) {
				var message = dojo.fromJson(response);
			});

		}
	});
}); */
	</script>
{% endblock %}
{% block content %}
		<div id="content-main">
		<ul class="messagelist"></ul>
		<h1>Add Book</h1>
			<input type="text" id="search" class="vTextField" name="search" size="30" value=""/>
			<input type="button" id="btn_search" value="Search" />
			<div id="books">
				<div class="form-row" id="firstrow"> No book found. </div>
			</div>
		</div>
{% endblock %}
